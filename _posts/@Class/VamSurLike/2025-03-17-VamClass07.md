---
title:  "[Unity 강의] 뱀서라이크 강의 - PoolManager "
excerpt: ""

categories:
    - Class VamSurLike
tags:
    - [C#, Unity, VamSurLike]

toc: true
toc_sticky: true
 
date: 2025-03-16 05:00

---
- - -

<br>
- - - 


# ObjectPool
✔ Instantiate는 자주 사용시 성능 문제가 발생할 수 있다.  
✔ 게임오브젝트를 Destroy하지 않고 비활성화하고 남겨둔다.  
✔ 필요할 때 Instantiate를 하지않고 숨겨둔 오브젝트를 활성화시켜서 보여준다.  
{:style="border:1px solid #EAEAEA; border-radius: 7px;"}
{: .notice--info}  

## ObjectPool`<T>`() 
[옛 정리글 ObjectPool()](https://levell1.github.io/memo%20unity/MUnity-ObjectPool/#3-%EC%9C%A0%EB%8B%88%ED%8B%B0-%EB%82%B4%EC%9E%A5-%ED%95%A8%EC%88%98)  
유니티에서 제공하는 클래스 `ObjectPool<T>()`  
![Image](https://github.com/user-attachments/assets/60cb9c8a-c1ae-4df3-8a01-bab78c0c96f2)  
{:style="border:1px solid #EAEAEA; border-radius: 7px;"}
{: .notice--info} 

<details>
<summary>ObjectPool()</summary>
<div class="notice--primary" markdown="1"> 

```c# 
public ObjectPool(
    Func<T> createFunc,        // 객체를 새로 생성하는 함수
    Action<T> actionOnGet,     // 풀에서 가져올 때 실행되는 함수
    Action<T> actionOnRelease, // 풀에 반환할 때 실행되는 함수
    Action<T> actionOnDestroy, // 객체가 완전히 삭제될 때 실행되는 함수
    bool collectionCheck = true,    // 중복 반환 검사
    int defaultCapacity = 10,       //초기용량
    int maxSize = 10000             //최대 용량
)

----------------------
public Pool(GameObject prefab)
{
    _prefab = prefab;
    _pool = new ObjectPool<GameObject>(OnCreate, OnGet, OnRelease, OnDestroy);
}

GameObject OnCreate()
{
    GameObject go = GameObject.Instantiate(_prefab);
    go.transform.parent = Root;
    go.name = _prefab.name;
    return go;
}

void OnGet(GameObject go)
{
    go.SetActive(true);
}

void OnRelease(GameObject go)
{
    go.SetActive(false);
}

void OnDestroy(GameObject go)
{
    GameObject.Destroy(go);
}

```
</div>
</details>

<br><br><br><br>

# PoolManager

**Pool생성,관리, 오브젝트 POP(나타남), PUSH(사라짐)**  
<details>
<summary>PoolManager</summary>
<div class="notice--primary" markdown="1"> 

```c# 
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Pool;

class Pool 
{
    GameObject _prefab;
    IObjectPool<GameObject> _pool;

    Transform _root;
    Transform Root
    {
        get
        {
            if (_root == null)
            {
                GameObject go = new GameObject() { name = $"{_prefab.name}Root" };
                _root = go.transform;
            }
            return _root;
        }
    }
    public Pool(GameObject prefab)
    {
        _prefab = prefab;
        _pool = new ObjectPool<GameObject>(OnCreate, OnGet, OnRelease, OnDestroy);
    }

    public void Push(GameObject go) 
    {
        _pool.Release(go);
    }
    public GameObject Pop()
    {
        return _pool.Get();
    }

    #region Funcs
    GameObject OnCreate()
    {
        GameObject go = GameObject.Instantiate(_prefab);
        go.transform.parent = Root;
        go.name = _prefab.name;
        return go;
    }

    void OnGet(GameObject go)
    {
        go.SetActive(true);
    }

    void OnRelease(GameObject go)
    {
        go.SetActive(false);
    }

    void OnDestroy(GameObject go)
    {
        GameObject.Destroy(go);
    }
    #endregion
}

public class PoolManager 
{
    Dictionary<string, Pool> _pools = new Dictionary<string, Pool>();

    public GameObject Pop(GameObject prefab) 
    {
        if (_pools.ContainsKey(prefab.name)== false)
            CreatePool(prefab);

        return _pools[prefab.name].Pop();
        
    }
    public bool Push(GameObject go) 
    {
        if (_pools.ContainsKey(go.name) == false)
            return false;

        _pools[go.name].Push(go);
        return true;
    }

    void CreatePool(GameObject prefab)
    {
        Pool pool = new Pool(prefab);
        _pools.Add(prefab.name, pool);
    }

}
```
</div>
</details>

**Object생성주기, 최대치등 설정, 코루틴으로 생성**  
<details>
<summary>SpawningPool</summary>
<div class="notice--primary" markdown="1"> 

```c# 
using System.Collections;
using UnityEngine;

public class SpawningPool : MonoBehaviour
{
    float _spawnInterval = 2.0f;
    int _maxMonsterCount = 100;
    Coroutine _coUpdateSpawningPool;

    void Start()
    {
        _coUpdateSpawningPool = StartCoroutine(CoUpdateSpawningPool());
    }

    IEnumerator CoUpdateSpawningPool() 
    {
        while (true) 
        {
            TrySpawn();
            yield return new WaitForSeconds(_spawnInterval);
        }
    }

    private void TrySpawn()
    {
        int monsterCount = Managers.Object.Monster.Count;
        if (monsterCount > _maxMonsterCount)
            return;

        MonsterController mc = Managers.Object.Spawn<MonsterController>(Random.Range(0, 2));
        mc.transform.position = new Vector2(Random.Range(-5, 5), Random.Range(-5, 5));
    }
}
```
</div>
</details>

## 몬스터 생성(Pool) 순서 
✔ 1. GameScene에서 SpawningPool AddComponent;   
✔ 2. SpawningPool Start() 에서 코루틴(x초마다 TrySpawn) 실행   
✔ 3. TrySpawn => Managers.Object.Spawn  
✔ 4. ObjectManager.Spawn => Managers.Resource.Instantiate(name, **pooling : true**);  
✔ 5. **pooling : true** 로 Managers.Resource.Instantiate   
✔ 6. Managers.Pool.Pop(prefab);  
✔ 7. return _pools`[prefab.name]`.Pop()  
✔ 8. return _pool.Get(); - Get => 객체 풀 에서 사용 가능한 GameObject를 하나 꺼내서 반환, OnGet실행  
객체가 pool 에 없으면 CreatePool로 새로 풀을 생성하고  
객체가 pool 에 있다면 비활성화된 오브젝트를 활성화 시켜 재사용  
{:style="border:1px solid #EAEAEA; border-radius: 7px;"}
{: .notice--info}  

<details>
<summary>실행순서 </summary>
<div class="notice--primary" markdown="1"> 

```c# 
//1. GameScene SpawningPool 컴포넌트 
public class GameScene : MonoBehaviour
{
    SpawningPool _spawningPool;
    void StartLoaded()
    {
        _spawningPool = gameObject.AddComponent<SpawningPool>();
    }
}

//2. SpawningPool TrySpawn => Managers.Object.Spawn
public class SpawningPool : MonoBehaviour
{
    private void TrySpawn()
    {
        MonsterController mc = Managers.Object.Spawn<MonsterController>(Random.Range(0, 2));
    }
}

//3. ObjectManager Spawn
public class ObjectManager 
{
    public T Spawn<T>(int  templateID =0) where T : BaseController 
    {
        System.Type type = typeof(T);
        else if(type == typeof(MonsterController))
        {
            string name = (templateID == 0 ? PrefabsName.Goblin : PrefabsName.Snake);
            GameObject go = Managers.Resource.Instantiate(name, pooling : true);

            MonsterController mc = go.GetOrAddComponent<MonsterController>();
            Monster.Add(mc);
            return mc as T;
        }
    }
}

//4. ResourceManager Instantiate
public class ResourceManager 
{


    public GameObject Instantiate(string key, Transform parent = null, bool pooling = false) 
    {
        GameObject prefab = Load<GameObject>($"{key}");

        //Pooling
        if (pooling==true)
            return Managers.Pool.Pop(prefab);
    }
}

//5. PoolManager CreatePool
public class PoolManager 
{
    Dictionary<string, Pool> _pools = new Dictionary<string, Pool>();

    public GameObject Pop(GameObject prefab) 
    {
        if (_pools.ContainsKey(prefab.name)== false)
            CreatePool(prefab);

        return _pools[prefab.name].Pop();
    }

    void CreatePool(GameObject prefab)
    {
        Pool pool = new Pool(prefab);
        _pools.Add(prefab.name, pool);
    }
}

//6. Pool.POP
class Pool 
{
    public GameObject Pop()
    {
        return _pool.Get();
    }
    void OnGet(GameObject go)
    {
        go.SetActive(true);
    }
}
```
</div>
</details>

<br><br><br><br>

## 몬스터 삭제(Pool) 순서 
✔ 1. 몬스터 사망 OnDead() => Managers.Object.Despawn(this);  
✔ 2. ObjectManager에서 디스폰 => Managers.Resource.Destroy(obj.gameObject);  
✔ 3. ResourceManager.Destroy pool에 있으면 push  
✔ 4. PoolManager Push => Pool Push  
✔ 5. Pool Push - OnRelease => go.SetActive(false); 비활성화  
객체를 삭제 하지 않고 SetActive(false)로 비활성화  
{:style="border:1px solid #EAEAEA; border-radius: 7px;"}
{: .notice--info}  

<details>
<summary>실행순서 </summary>
<div class="notice--primary" markdown="1"> 

```c# 
//1. MonsterController OnDead() => Managers.Object.Despawn(this); 
public class MonsterController : CreatureController
{
    protected override void OnDead()
    {
        Managers.Object.Despawn(this);
    }
}

//2. ObjectManager Despawn => Managers.Resource.Destroy(obj.gameObject);
public class ObjectManager 
{
    public void Despawn<T>(T obj) where T : BaseController 
    {
        System.Type type = typeof(T);

        else if (type == typeof(MonsterController))
        {
            Monster.Remove(obj as MonsterController);
            Managers.Resource.Destroy(obj.gameObject);
        }
    }
}

//3 ResourceManager Destroy
public class ResourceManager 
{
    public void Destroy(GameObject go) 
    {
        if (go == null)
            return;

        if (Managers.Pool.Push(go))
            return;

        Object.Destroy(go);
    }
}

//4. PoolManager Push
public class PoolManager 
{
    public bool Push(GameObject go) 
    {
        if (_pools.ContainsKey(go.name) == false)
            return false;

        _pools[go.name].Push(go);
        return true;
    }
}

//5. Pool Push - OnRelease
class Pool 
{
    public void Push(GameObject go) 
    {
        _pool.Release(go);
    }

    void OnRelease(GameObject go)
    {
        go.SetActive(false);
    }
}
```
</div>
</details>

<br><br><br><br>

# 이것저것 메모

## _pool.Release(), _pool.get(go);
✔ _pool.Release(go); => go가 풀에 들어가고 비활성화 됨.   
✔ _pool.get(go);  => 풀에 사용 가능한 GameObject를 꺼냄.  
{:style="border:1px solid #EAEAEA; border-radius: 7px;"}
{: .notice}  

<br><br><br>
- - - 

# 잡담, 일기?
리소스관리 오브젝트 풀링
{:style="border:1px solid #EAEAEA; border-radius: 7px;"}
{: .notice--success}  


<br><br>
- - -